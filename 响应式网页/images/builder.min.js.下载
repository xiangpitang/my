jQuery(function($) {
    setBuilderHandlers();
    $('#builder_form_holder').modal({backdrop: 'static', show: false});
});

var setBuilderHandlers = function() {
    var $ = jQuery;
    
    $('.bld').unbind('click');
    $('.bld').click(function(){ $('#builder_form_holder').modal('show') });
    
    $('.builder_form').unbind('submit');
    $('.builder_form').submit(saveBuilderForm);
    
    $('.color_picker li a').unbind('click');
    $('.color_picker li a').click(function(){
        var color = '#' + $(this).attr('data-color');
        $(this).closest('.color_picker_holder').find('.color').val(color);
        $(this).closest('.color_picker_holder').find('.color').css({'border-left-color': color});
    });
    
    $('.color').unbind('change');
    $('.color').change(function(){
        $(this).css({'border-left-color': $(this).val()});
    });
    
    $('.color').unbind('keyup');
    $('.color').keyup(function(){
        $(this).css({'border-left-color': $(this).val()});
    });
    
    $('.add-photo').unbind('click');
    $('.add-photo').click(function(){
        $(this).siblings('.photo-input').click(); 
    });
    
    $('.remove-photo').unbind('click');
    $('.remove-photo').click(function(){ 
        $(this).siblings('.photo-input').val('');
        $(this).siblings('.photo-input').change();
    });
    
    $('.photo-input').unbind('change');
    $('.photo-input').change(function(){
        var file = $(this).val();
        //console.log(file);
        if (file) {
            $(this).siblings('.add-photo').hide();
            $(this).siblings('.remove-photo').show();
            $(this).siblings('.remove-photo-input').val(0);
        } else {
            $(this).siblings('.remove-photo').hide();
            $(this).siblings('.add-photo').show();
            $(this).siblings('.remove-photo-input').val(1);
        }
    });
    
    if (typeof uploadcare != 'undefined') {
        $.each(uploadcare.initialize(), function(i, widget) {
            function onChange(file) {
                // Fire only once
                widget.onChange.remove(onChange);
                if (file.state() == 'rejected') {
                    file.fail(function(reason) {
                        if (reason == 'baddata') {
                            var value = $(widget.inputElement).val();
                            widget.value(null);
                            $(widget.inputElement).val(value);
                        }
                    });
                }
            }
            widget.onChange.add(onChange);
        });
    }
}

var saveBuilderForm = function(e){
    var $ = jQuery,
        form = $(this),
        buttonText = $(form).find('#submit').val(),
        formData = new FormData(),
        idPrefix = ($(form).find('#edit').length)?'edit_':'',
        idSuffix = ($(form).find('#edit').length)?'_editor':'_builder', 
        data = {
            action: 'receive_builder_form',

            // General
            title: $(form).find('#title').val(),
            desc: $(form).find('#desc').val(),
            confirmation: $(form).find('#confirmation').val(),
            
            logo_image: $(form).find('#logo_image').val(),
            color: $(form).find('#button_color').val(),
            hide_border: ($(form).find('#hide_border').prop('checked'))?1:0,
            hide_share_embed: ($(form).find('#hide_share_embed').prop('checked'))?1:0,
            
            bg_image: $(form).find('#bg_image').val(),
            bg_color: $(form).find('#bg_color').val(),
            light_text: ($(form).find('#light_text').prop('checked'))?1:0,
            
            show_first_name_field: ($(form).find('#show_first_name_field').prop('checked'))?1:0,
            show_last_name_field: ($(form).find('#show_last_name_field').prop('checked'))?1:0,
            
            incentive_title: $(form).find('#incentive_title').val(),
            incentive_url: $(form).find('#incentive_url').val(),
            
            activate_auto_response: ($(form).find('#activate_auto_response').prop('checked'))?1:0,
            auto_response_subject: $(form).find('#auto_response_subject').val(),
            auto_response_message: $(form).find('#auto_response_message_textarea' + idSuffix).val(),
            
            terms_link: $(form).find('#terms_link').val(),
            privacy_policy_link: $(form).find('#privacy_policy_link').val(),

            // Edit form id
            edit: ($(form).find('#edit').val()||false)
        };
    
    if (e) e.preventDefault();
    
    $(form).find('#submit').val('Wait for it...wait for it!');

    for (var name in data)
        formData.append(name, data[name]);

    $.ajax({
        type: 'POST',
        url: (typeof ajaxUrl === 'undefined') ? '/wp-admin/admin-ajax.php' : ajaxUrl,
        data: formData,
        //cache: false,
        contentType: false,
        processData: false,
        success: function(response) {
            response = $.parseJSON(response);

            if (response.login) {
                // Open login form
                openLoginForm();
                $('#builder_form_holder').modal('hide');
                return false;
            }

            // Error?
            if (response && response.success == '1') {
                if (response.link) {
                    if (data.edit && $('body').hasClass('page-template-template-dash')) {
                        window.location.hash = data.edit + '|main';
                    } else {
                        $(form).find('#submit').val('Success! Let\'s see it.');
                        window.location.href = response.link;
                    }
                    return true;
                }
            } else {
                if (response.message) {
                    //console.log($(form).find('#submit'));
                    $(form).find('#submit').val(response.message);
                } else {
                    $(form).find('#submit').val('Oops! Please try again.');
                }

                setTimeout(function(){
                    $(form).find('#submit').val(buttonText);
                }, 2500);
            }
        },
        error: function(data){
            console.log("error");
            console.log(data);
        },
    });

    return false;
}

var openEditScreen = function(isHash) {
    var $ = jQuery;
    var postId = $(this).attr('data-edit');
    if (isHash !== true && postId) {
    	 $('*#edit_form_holder input#edit').val(postId);
    }
    $('#edit_form_holder').modal('show');
}